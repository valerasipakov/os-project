# Архитектура и устройство проекта

Документ описывает назначение файлов, потоки данных и ключевые решения для двух частей задания:

- Часть I — анализ результатов тестов (`main.sh`);
- Часть II — работа с досье и средними оценками (`student_notes.sh`, `avg_score.sh`).

---

## Дерево проекта

```
.
├── config/
│   └── app.env
├── data/
│   └── labfiles-25/
│       ├── Цирковое_Дело/tests/TEST-* …
│       ├── Поп-Культуроведение/tests/TEST-* …
│       └── students/
│           ├── groups/
│           └── general/notes
├── src/
│   └── scripts/
│       ├── main.sh
│       ├── student_notes.sh
│       ├── avg_score.sh
│       └── lib/
│           ├── io.sh
│           ├── paths.sh
│           ├── parser.sh
│           └── stats.sh
└── src/tests/unit_tests/
    ├── conftest.py
    ├── test_happy_path.py
    └── test_group_validation.py
```

---

## Роли основных файлов

- `config/app.env` — точка настройки `DATA_ROOT` с поддержкой шаблона `${PROJECT_ROOT}`.
- `src/scripts/main.sh` — входная точка Часть I: загрузка конфигурации, нормализация `DATA_ROOT`, подключение библиотек, разбор аргументов, запуск вычислений и форматирование результата.
- `src/scripts/student_notes.sh` — скрипт Часть II.1: просмотр и редактирование досье конкретного студента.
- `src/scripts/avg_score.sh` — скрипт Часть II.2: расчёт средней оценки студента по предмету.
- `src/scripts/lib/io.sh` — вспомогательные функции ввода/вывода (в т.ч. для старого интерактивного режима).
- `src/scripts/lib/paths.sh` — слой путей и общих справочных данных:
  - вычисление `LAB_ROOT` из `DATA_ROOT`/`PROJECT_ROOT`;
  - `get_subject_tests_dir(subject)` — каталог с тестами по предмету;
  - `get_test_file(subject, test_name)` — путь к конкретному файлу теста;
  - `get_notes_dir()` и `get_notes_file_for_student(student)` — каталог и файл для досье.
- `src/scripts/lib/parser.sh` — парсер аргументов и общие утилиты (`trim` и т.п.).
- `src/scripts/lib/stats.sh` — бизнес-логика анализа тестов (поиск студентов с максимумами).
- `src/tests/unit_tests/*` — юнит-тесты для проверки сценариев Часть I.

---

## Часть I. Скрипт `main.sh`

### Поток выполнения

1. Определяется `SCRIPT_DIR` и `PROJECT_ROOT` на основе местоположения `main.sh`.
2. Если переменная окружения `DATA_ROOT` не задана, подключается `config/app.env` и оттуда подхватывается значение `DATA_ROOT`.
3. Если `DATA_ROOT` задан, он проверяется на существование каталога и нормализуется до абсолютного пути.
4. Экспортируется `DATA_ROOT`, подключаются `io.sh`, `paths.sh`, `parser.sh` (опционально) и `stats.sh`.
5. Внутри `main.sh` разбираются аргументы командной строки:
   - `--group`;
   - `--subject`;
   - `--test` (опционально);
   - `--action`.
6. Значения очищаются от пробелов по краям (функция `trim`).
7. Проверяется наличие всех обязательных флагов (`--group`, `--subject`, `--action`). При отсутствии любого из них скрипт печатает сообщение вида `Необходимо указать флаг --group`, выводит краткую справку и завершает работу с кодом `1`.
8. Строится путь к каталогу тестов выбранного предмета (`get_subject_tests_dir`) и, при наличии `--test`, к конкретному файлу (`get_test_file`).
9. Проверяется существование файла(ов) тестов. В случае отсутствия — ошибка и код `1`.
10. С помощью функций из `stats.sh` выполняется анализ тестов:
    - найденные студенты с максимальным числом правильных ответов;
    - студенты с максимальным числом неправильных ответов.
11. Результаты форматируются и печатаются в `stdout`.

Формат строк в файлах тестов:

```text
<Группа>;<ФамилияИО>;<Дата>;<Правильных>;<Оценка>
```

---

## Часть II.1. Скрипт `student_notes.sh`

### Поток выполнения

1. Определяются `SCRIPT_DIR` и `PROJECT_ROOT`.
2. При необходимости подхватывается и нормализуется `DATA_ROOT` (через переменную окружения или `config/app.env`).
3. Подключается `paths.sh`, который вычисляет `LAB_ROOT` и функции работы с досье.
4. Разбираются аргументы:
   - первый позиционный аргумент — идентификатор студента (`ФамилияИО`, например `RusinAN`);
   - второй аргумент (опционально) — флаг `--add`.
5. В зависимости от наличия `--add` выбирается режим:
   - `view` — просмотр досье;
   - `add` — добавление новой записи.

### Представление досье

Досье хранится блоками, разделёнными строками из `====`:

```text
====================
RusinAN
Первая строка досье
Вторая строка досье
====================
```

При просмотре блока для нужного студента строки между верхней и нижней границей собираются, пробелы по краям обрезаются, и выводятся одной строкой после префикса `Досье студента ...`.

При добавлении новой записи:

- если у студента уже есть строки досье, новая строка вставляется **сразу после последней строки досье** (перед нижней границей блока);
- если досье пока пустое, строка добавляется первой строкой после имени.

Обновлённый файл полностью перезаписывается.

---

## Часть II.2. Скрипт `avg_score.sh`

### Назначение

`avg_score.sh` считает среднюю оценку студента по выбранному предмету в соответствии с ТЗ 2.2.

### Поток выполнения

1. Определяются `SCRIPT_DIR`, `PROJECT_ROOT`, подхватывается/проверяется `DATA_ROOT`.
2. Подключается `paths.sh` и через `get_subject_tests_dir` определяется каталог тестов предмета.
3. Разбираются аргументы:
   - первый позиционный аргумент — `ФамилияИО` студента;
   - второй — `subject` (например, `Цирковое_Дело`).
4. Проверяется, что каталог с тестами существует.
5. С помощью одного прохода `awk` по всем файлам `TEST-*`:
   - выбираются строки с заданным студентом по полю `$2`;
   - из поля `$5` (оценка) удаляются символы `+` и `-`, при необходимости заменяется запятая на точку;
   - оценки конвертируются в числа и суммируются, параллельно считается количество попыток.
6. В блоке `END` вычисляется среднее значение `sum / cnt` и печатается с точностью до двух знаков (`printf "%.2f"`).

### Ввод/вывод

- Ввод — только позиционные аргументы: `ФамилияИО` и `subject`.
- Вывод:

  ```text
  Средняя оценка студента RusinAN по предмету Цирковое_Дело: 4.27
  ```

- При отсутствии оценок выводится:

  ```text
  Оценки студента RusinAN по предмету Цирковое_Дело не найдены
  ```

Ошибки (например, отсутствие каталога тестов) печатаются в `stderr`.

---

## Возможные направления развития

- Добавить авто-тесты для `student_notes.sh` и `avg_score.sh`.
- Вынести общие операции по парсингу аргументов в `parser.sh`.
- Добавить поддержку других предметов и форматов оценок.
